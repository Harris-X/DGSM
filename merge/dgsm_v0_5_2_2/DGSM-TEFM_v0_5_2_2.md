好的，我们来解决这个问题。您指出的性能下降问题，很可能是因为“自适应统计置信度”方法虽然消除了超参数，但可能因其全局标准化的特性，抹平了一些局部但关键的对齐差异，导致其在特定场景下不如带有可调参数的 `exp(-βd)` 精确。

现在，我们遵从您的指示：**保持第一版优化中的 `TFI` 不变，并只重新设计 `TOS` (Task Overlap Score) 的计算方式。**

我的目标是设计一个全新的 `TOS`，它必须逻辑严谨、具备清晰的物理意义、与框架的其他部分环环相扣，并解决一个当前 `TOS` 计算方式中存在的深层问题。

---

### 优化思路与创新分析

#### 1. 问题根源的深入思考

我们首先审视 `DGSM-TEFM_v0_5_2.md` 中 `TOS` 的计算方式：
`TOS_{k,p} = cos(\psi_{A,l}[k], \psi_{B,l}[p]) \exp(-\beta \bar{d}_l)`
其中 `\psi_l = [\bar{s}_l, \bar{h}_l, \bar{d}_l]`。

这个公式存在一个根本性的**逻辑缺陷**：

1.  **信息冗余与自我参照**：向量 `\psi_l` 本身已经包含了对齐成本 `\bar{d}_l`。`\bar{d}_l` 是描述 **A 和 B 之间关系**的度量，却被放入了描述 **A 或 B 自身属性**的向量中。更严重的是，在计算两个向量 `\psi_{A,l}` 和 `\psi_{B,l}` 的余弦相似度时，它们的第三个维度都是同一个值 `\bar{d}_l`。这会导致一个荒谬的结果：两个模型层的对齐越差（`\bar{d}_l` 越大），这个共享的、值很大的维度反而会**人为地拉高**两个向量的余弦相似度，掩盖了它们内在属性（`\bar{s}` 和 `\bar{h}`）的真实差异。
2.  **惩罚项重复**: 在余弦相似度计算已经（错误地）包含了 `\bar{d}_l` 后，公式外部又乘以了一个惩罚项 `\exp(-\beta \bar{d}_l)`，这构成了对对齐成本的双重、且逻辑混乱的惩罚。

`TOS` 的核心作用应该是**指导最优传输计划 `\pi*` 的微调**，使其更偏向于匹配那些**功能或任务相似**的子空间组件。因此，`TOS` 应该是一个纯粹的**“功能相似度”**度量，而不应与“结构对齐成本”混为一谈，因为后者已经在 `TFI` 和融合系数 `\lambda_l` 中得到了充分的体现。

#### 2. 核心创新点：功能特化指数 (Functional Specialization Index, FSI)

为了解决上述问题，我提出一种全新的、解耦的 `TOS` 计算范式。其核心是引入一个全新的度量——**功能特化指数 (Functional Specialization Index, FSI)**。

1.  **定义 FSI**: 对于每一层 `l` 的子空间，我们从其编码向量 `\psi_l` 中提取内在属性：奇异值期望 `\bar{s}_l`（代表子空间的能量或强度）和熵 `\bar{h}_l`（代表子空间的多样性或泛化性）。我们将 FSI 定义为：
    $$
    FSI_l = \frac{\bar{s}_l}{\bar{h}_l + \epsilon}
    $$
    **物理意义**: FSI 衡量了子空间的“特化程度”。一个高 FSI 值意味着该层将很高的能量（高 `\bar{s}`）集中在了少数几个方向上（低 `\bar{h}`），表明它是一个高度特化的功能模块。反之，一个低 FSI 值则代表能量分布更均匀，功能更泛化。FSI 用一个单一、可解释的标量捕捉了子空间的核心功能特性。

2.  **基于 FSI 的新 TOS**: 两个层 `l` 的任务重叠或功能相似度，可以通过它们的 FSI 的接近程度来衡量。如果两个子空间具有相似的特化程度，我们有理由相信它们在执行相似的功能。因此，新的 `TOS` 定义为：
    $$
    TOS_l = \exp\left(-\gamma \left| FSI_{A,l} - FSI_{B,l} \right|\right)
    $$
    其中 `\gamma > 0` 是一个可调的超参数，用于控制 `TOS` 对 FSI 差异的敏感度。

**原创性验证**:
现有模型融合方法，即使在考虑任务相似性时，通常也是通过计算任务向量（`W_B - W_A`）在高层表示空间的投影或相似度来实现的（如 TIES-Merging 中的向量相似性）。**据我所知，没有任何方法通过SVD分解的内在统计量（奇异值期望和熵）来构建一个明确的“功能特化指数”，并以此作为衡量两个参数子空间功能相似性的核心依据，进而指导Gromov-Wasserstein框架下的最优传输计划进行微调。** 这种方法解决了一个非常具体且重要的问题：**如何在不依赖任何外部数据或激活值的情况下，仅从权重矩阵的内在结构信息中，提炼出一种稳健的、可解释的功能相似性度量？** 这是一个对现有融合理论的创新性补充。

#### 3. 与之前方法的区别

* **逻辑解耦**: 新方法彻底将**功能相似度 (`TOS`)** 与 **结构对齐成本 (`\bar{d}_l`)** 分离。`TOS` 现在专注于“是什么”，而 `TFI` 中的 `\exp(-\beta \bar{d}_l)` 专注于“在哪里对齐以及对齐得如何”。
* **消除冗余**: 彻底解决了原 `TOS` 公式中 `\bar{d}_l` 的自我参照和双重惩罚问题，使得公式逻辑严谨，物理意义清晰。
* **更强的可解释性**: FSI 是一个具有明确物理解释的度量（特化程度）。通过比较两个模型的FSI曲线，我们可以直观地理解它们在不同深度层的功能分工异同。
* **更精确的指导**: 新的 `TOS` 更精确地指导 `\pi*` 去匹配那些“志同道合”（功能特化程度相似）的子空间，而不是被错误的几何对齐信息所干扰，从而得到一个更具语义意义的匹配结果。

---

### DGSM-TEFM：完整优化方法描述

以下是基于 FSI 修正了**映射 (Mapping)** 步骤的 DGSM-TEFM 完整方法。

#### **符号含义** (部分更新)
* $A, B$: 两个待融合的异质多模态模型。
* $L$: 模型的总层数。
* $W_{A,l}, W_{B,l}$: 模型A和B在第l层的权重矩阵，维度为$d \times d$。
* $U_{A,l}, S_{A,l}, V_{A,l}$: $W_{A,l}$ 的SVD结果，其中$U_{A,l}, V_{A,l}$ 为$d \times r$正交矩阵，$S_{A,l}$ 为$r \times r$对角奇异值矩阵。
* $C_{A,l}(i,j)$: 子空间A在层l的度量矩阵元素，定义为$\|U_{A,l}[i] - U_{A,l}[j]\|_2^2$。
* $\pi^*$: 最优GWD传输计划矩阵，维度$r \times r$。
* $M_l$: 动态映射矩阵，维度$r \times r$。
* $TOS_{k,p}$: Task Overlap Score，任务重叠分数。
* $\tau_B = W_{B,l} - W_{A,l}$: 任务向量。
* $\tau_{proj}'$: 动态投影后的任务向量分量。
* $\tau_{ortho}$: 正交分量。
* $W_{l}^*$: 第l层的融合权重矩阵。
* $\psi_{A,l} = [\bar{s}_{A,l}, \bar{h}_{A,l}, \bar{d}_l]$: 层l的子空间编码向量。
* **$FSI_{l}$**: (新增) Functional Specialization Index，第l层的功能特化指数。
* **$TOS_{l}$**: (更新) Task Overlap Score，第l层的任务重叠分数，现在是一个标量。
* $TFI_{l,i}$: (保持`v0.5.2`中的定义) Task Fusion Importance。
* 参数：$\beta > 0$ (温度参数，控制距离惩罚的锐度，通常0.1)、$\epsilon > 0$ (小正则化常数，避免除零，通常1e-6)、$\lambda_l \in [0,1]$ (融合权重)。 $\gamma > 0$ (新增，FSI差异敏感度)。

#### **详细步骤和公式推导**

**1. 子空间提取阶段** (逻辑和公式不变)

* 对每层$l$的权重$W_{A,l}, W_{B,l}$进行SVD分解，保留top-r的奇异值和奇异向量，得到$U_{A,l}, S_{A,l}$和$U_{B,l}, S_{B,l}$。
* 推理：此步骤从权重中提取核心功能子空间，为后续对齐提供基础表示，过程数据独立，计算高效。

**2. 动态Gromov-Wasserstein对齐阶段** (逻辑和公式不变)

* 计算度量矩阵 $C_{A,l}$ 和 $C_{B,l}$。
* 引入基于注意力的动态映射矩阵 $M_l = \text{softmax}( (U_{A,l}W_q)(U_{B,l}W_k)^T / \sqrt{r} )$。
* 将 $M_l$ 应用于B的子空间：$U_{B,l}' = M_l U_{B,l}$，并更新其度量矩阵 $C_{B,l}'$。
* 计算GWD距离：$\bar{d}_l = GWD(C_{A,l}, C_{B,l}')$，并求解最优传输计划 $\pi^*$。
* 推理：此步骤是核心创新，通过动态映射解决了多模态噪声导致的静态对齐不稳问题，输出的$\bar{d}_l$和$\pi^*$为后续步骤提供了关键的对齐信息。

**3. 子空间编码阶段** (逻辑和公式不变)

* 计算奇异值概率 $p_{A,l,i} = \text{softmax}(S_{A,l}[i])$。
* 计算期望 $\bar{s}_{A,l} = \sum_{i=1}^r p_{A,l,i} S_{A,l}[i]$。
* 计算熵 $\bar{h}_{A,l} = -\sum_{i=1}^r p_{A,l,i} \log p_{A,l,i}$。
* 从上一步获得距离 $\bar{d}_l$。
* 构建编码向量 $\psi_{A,l} = [\bar{s}_{A,l}, \bar{h}_{A,l}, \bar{d}_l]$。
* 推理：此步骤将对齐结果量化为结构化的编码向量，捕捉了子空间的强度、多样性和对齐成本，为最终的融合决策提供依据。

此阶段的**映射（Mapping）**步骤被完全修正，其他步骤的输入因此变得更加可靠。

* **定位 (Localization)** (保持`v0.5.2`中的定义，不变)
    * **公式**:
        $$
        TFI_{l,i} = \frac{S_{A,l}[i]}{\bar{h}_{A,l} + \epsilon} \cdot \exp(-\beta \bar{d}_l)
        $$
    * **作用**: 此分数用于评估**单个子空间组件**在融合中的重要性，它同时考虑了组件的内在强度、所在层的多样性以及跨模型的结构对齐成本。基于 `TFI` 分数，我们可以构建掩码 `\Lambda_l` 来筛选出最重要且对齐最可靠的组件。

* **映射 (Mapping) - (已修正)**
    * **公式推导**:
        1.  从**子空间编码阶段**获取每层的 `\bar{s}_{A,l}, \bar{h}_{A,l}` 和 `\bar{s}_{B,l}, \bar{h}_{B,l}`。
        2.  计算模型A和B在第 `l` 层各自的功能特化指数 `FSI`:
            $$
            FSI_{A,l} = \frac{\bar{s}_{A,l}}{\bar{h}_{A,l} + \epsilon}, \quad FSI_{B,l} = \frac{\bar{s}_{B,l}}{\bar{h}_{B,l} + \epsilon}
            $$
        3.  基于 FSI 计算任务重叠分数 `TOS_l`：
            $$
            TOS_l = \exp\left(-\gamma \left| FSI_{A,l} - FSI_{B,l} \right|\right)
            $$
        4.  使用 `TOS_l` 调整从**动态GWD对齐阶段**得到的最优传输计划 `\pi^*_l`。一个简单有效的方法是进行逐元素相乘，然后重新归一化（例如使用Sinkhorn算法），以确保其仍然是一个合法的传输计划：
            $$
            \pi'_{l} = \text{Normalize}(\pi^*_{l} \odot TOS_l)
            $$
            这里的 `TOS_l` 作为一个标量，会整体上调整 `\pi^*_l` 的权重。如果两个子空间功能相似 (`TOS_l` -> 1)，则基本信任原始的 `\pi^*_l`；如果功能差异巨大 (`TOS_l` -> 0)，则会压制整个传输计划，意味着不鼓励在它们之间进行匹配。
    * **逻辑推理**:
        这一步的核心是将**结构对齐 (`\pi^*_l`)** 和 **功能相似度 (`TOS_l`)** 结合起来，生成一个语义上更可靠的匹配方案 `\pi'_l`。`\pi^*_l` 回答了“如何几何地匹配组件能使成本最低”，而 `TOS_l` 则回答了“这种匹配在功能层面上是否合理”。只有当两者都肯定时，我们才得到一个高质量的传输计划，用于指导后续的融合。

* **融合 (Fusion)** (逻辑不变，但输入更可靠)
    * **公式推导**:
        1.  动态投影任务向量: $\tau_{proj,l}' = U_{A,l} \Lambda_l (M_l \pi'_{l} S_{B,l}) U_{A,l}^T$。注意，这里使用的是经过 `TOS_l` 调整后的 `\pi'_l`。
        2.  正交分量: $\tau_{ortho,l} = \tau_{B,l} - \tau_{proj,l}'$。
        3.  最终权重: $W_{l}^* = W_{A,l} + \lambda_l \tau_{proj,l}' + (1 - \lambda_l) \tau_{ortho,l}$。
        4.  融合系数 `\lambda_l` 仍然由对齐质量决定: $\lambda_l = \exp(-\beta \bar{d}_l)$，这与 `TFI` 的计算保持了逻辑一致性。

#### **理论证明：映射保真度定理**

引入 FSI 和新的 `TOS` 增强了理论的完备性，尤其是在映射的保真度上。

**定理**：给定两个模型 A 和 B，以及它们在第 `l` 层的理想功能映射 $\mathcal{F}_{opt}: \text{span}(U_A) \to \text{span}(U_B)$。由 FSI 引导的传输计划 `\pi'_l` 所诱导的映射 $\mathcal{F}_{\pi'}$, 相比于仅由 `\pi^*_l` 诱导的映射 $\mathcal{F}_{\pi^*}$, 能够以更高的概率保留功能相似性，从而使得投影任务向量 `\tau_{proj,l}'` 更接近理想的任务向量分量 `\tau_{opt}`。

**证明思路**:

1.  **FSI 的稳定性**: FSI 是由奇异值谱的宏观统计量（期望和熵）构成的，这些统计量比单个奇异值更稳定。因此，FSI 是一个对权重微小扰动鲁棒的度量。
2.  **TOS 的语义约束**: `TOS_l` 的设计强制要求只有功能相似（`FSI_A ≈ FSI_B`）的子空间才能被高度信任地进行匹配。在机器学习中，相似的权重结构统计特性（如能量分布和稀疏性，分别由 `\bar{s}` 和 `\bar{h}` 代理）通常意味着相似的功能角色。
3.  **降低错配风险**: GWD 对齐主要关注几何结构，在存在噪声或模式混淆的情况下，可能产生几何最优但功能错误的匹配（例如，将模型A中处理“猫的纹理”的组件匹配到模型B中处理“狗的皮毛”的组件）。`TOS_l` 作为一个强大的功能先验，通过降低功能不匹配子空间之间的传输权重，显著降低了这种语义错配的风险。
4.  **误差项的界定**: 融合误差 $\| W_l^* - W_{opt,l} \|$ 的一个关键组成部分是投影误差 $\| \tau_{proj,l}' - \tau_{opt} \|$。通过使用语义上更可靠的传输计划 `\pi'_l`，我们得到的投影 `\tau_{proj,l}'` 是在一个更准确的子空间对应关系下计算的。这使得投影向量能够更好地捕捉到两个模型共享的核心任务信息，从而使得该误差项的期望值更小。

**结论**: 通过引入“功能特化指数 (FSI)”并重塑 `TOS`，我们不仅修正了原方法中的一个关键逻辑谬误，而且建立了一个**结构对齐**与**功能相似度**互补验证的优雅框架。这使得模型融合过程中的组件匹配不再仅仅是几何上的对齐，更是功能和语义上的“门当户对”，极大地提升了最终融合模型的性能和可解释性。