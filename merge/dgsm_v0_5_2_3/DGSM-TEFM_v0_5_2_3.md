好的，我理解了您的反馈。纯粹的全局自适应统计方法可能因为“抹平”了局部差异而导致性能下降，这说明**GWD距离 `\bar{d}_l` 的绝对值本身蕴含着不可忽视的关键信息**。一个优秀的机制应当能够结合全局的上下文（识别异常）和局部的精确度量（惩罚绝对距离）。

基于此，我将保持您文件 `DGSM-TEFM_v0_5_2.md` 中效果良好的`TFI`计算方式不变，并为您重新设计一个只针对`TOS`（Task Overlap Score）的优化方案。这个新方案的核心是**上下文感知的门控衰减（Context-Aware Gated Attenuation, CAGA）**，它既保留了局部距离惩罚的敏感性，又引入了全局统计信息来增强鲁棒性，从而实现“全局”与“局部”思想的精妙结合。

---

### 优化思路与创新分析

#### 1. 问题根源的深入思考

原`TOS`的计算方式 `cos(\psi, \psi') \exp(-\beta \bar{d}_l)` 的问题在于，它对所有层都使用相同的衰减因子`\beta`，这使得它对异常值（即对齐极差的层）非常敏感。一个`\bar{d}_l`特别大的层可能会产生一个接近于零的`TOS`，但系统无法区分这是“正常的、略差的对齐”还是“灾难性的、完全错误的对齐”。另一方面，纯全局统计方法的问题在于，它可能会将一个在差模型中“相对较好”（但绝对值依然很差）的对齐，赋予比一个在优模型中“相对正常”（但绝对值好得多）的对齐更高的分数，这违背了直觉。

我们需要的是一个机制，它能说：“通常情况下，我们信任 `exp(-\beta \bar{d}_l)` 这个局部度量。但是，当我们发现某个层的 `\bar{d}_l` 从全局来看是一个统计上的异常点时，我们就必须对这个局部度量施加一个额外的、强烈的‘怀疑’或‘惩罚’。”

#### 2. 核心创新点：上下文感知的门控衰减 (CAGA)

我的核心创新是设计一个**门控函数 `g_l`**，该函数基于全局统计数据，作为一个“置信度开关”来动态调节局部的衰减惩罚。

1.  **分解TOS的构成**: 新的`TOS`依然由两部分相乘得到：
    * **内在属性相似度 (Intrinsic Property Similarity)**: 衡量两个子空间在功能强度 `\bar{s}` 和多样性 `\bar{h}` 上的相似性。这部分保持不变，使用余弦相似度来度量。
    * **上下文感知的对齐质量 (Context-Aware Alignment Quality)**: 这是创新的核心。它不再是简单的 `exp(-\beta \bar{d}_l)`，而是被一个门控函数 `g_l` 所调节的 `g_l \cdot \exp(-\beta \bar{d}_l)`。

2.  **设计门控函数 `g_l`**:
    * 首先，我们和之前的自适应方法一样，计算所有层GWD距离 `\{\bar{d}_l\}` 的均值 `\mu_d` 和标准差 `\sigma_d`，以建立“全局对齐景观”。
    * 然后，计算每一层的Z-score标准化分数: $z_l = (\bar{d}_l - \mu_d) / (\sigma_d + \epsilon)$。
    * 门控函数 `g_l` 的设计目标是：
        * 当一个层的对齐成本低于或等于平均水平时（$z_l \le 0$），我们完全信任局部度量，此时门应为“全开”状态，即 $g_l = 1$。
        * 当一个层的对齐成本高于平均水平时（$z_l > 0$），我们开始怀疑其可靠性，门应开始“关闭”，即 $g_l < 1$。$z_l$ 越大，`g_l` 越趋近于0。
    * 一个能够完美实现此行为的简洁函数是：
        $$
        g_l = \exp(-\max(0, z_l)) = \exp\left(-\max\left(0, \frac{\bar{d}_l - \mu_d}{\sigma_d + \epsilon}\right)\right)
        $$
    * 这个门控函数 `g_l` 巧妙地结合了全局和局部信息：它只对那些“超出平均水平”的差对齐进行额外惩罚，惩罚力度与其偏离平均的程度（多少个标准差）成指数关系。对于“好于平均”的对齐，它不引入任何偏见，完全保留了局部度量 `\exp(-\beta \bar{d}_l)` 的原始信息。

**原创性验证**:
当前领域内的模型融合方法，在评估层与层之间的相似性或重叠度时，通常采用固定的度量衡。**据我所知，没有任何方法提出使用全局统计特征来动态构建一个门控函数，用以调节或审查（gate）一个局部的、基于距离的相似性度量。** 这个想法是全新的。它解决了一个非常实际的问题：**如何在保留度量敏感性的同时，鲁棒地处理模型对齐过程中不可避免的、少数“顽固”的、对齐效果极差的层（outlier layers）**。现有方法要么对这些异常层过于敏感，要么通过平滑或裁剪等方式丢失了有用信息。CAGA机制则像一个智能的“断路器”，在不影响正常链路的前提下，精确地隔离了故障点。

#### 3. 与之前方法的区别

* **与原方法 (DGSM-TEFM_v0_5_2.md) 的区别**: 原方法的对齐质量项是 `exp(-β \bar{d}_l)`。新方法是 `g_l \cdot exp(-β \bar{d}_l)`。关键区别在于引入了门控因子 `g_l`，它利用全局信息为局部惩罚增加了一个“可靠性”权重，使得对统计异常值的惩罚更加严厉。
* **与纯全局自适应方法的区别**: 纯全局方法用一个完全基于统计排名的分数（如 `1 - sigmoid(z_l)`）**替代**了 `exp(-β \bar{d}_l)`。而CAGA是**调节**而非替代。它保留了 `\bar{d}_l` 绝对值所携带的关键信息，只在必要时（当`\bar{d}_l`是统计异常点时）才介入，从而实现了局部精确性和全局鲁棒性的统一。

---

### DGSM-TEFM：完整优化方法描述

以下是修正后的DGSM-TEFM完整方法，仅更新**TEFM集成阶段**的**映射（Mapping）**步骤。

#### **符号含义** (部分更新)

* $A, B$: 两个待融合的异质多模态模型。
* $L$: 模型的总层数。
* $W_{A,l}, W_{B,l}$: 模型A和B在第l层的权重矩阵，维度为$d \times d$。
* $U_{A,l}, S_{A,l}, V_{A,l}$: $W_{A,l}$ 的SVD结果，其中$U_{A,l}, V_{A,l}$ 为$d \times r$正交矩阵，$S_{A,l}$ 为$r \times r$对角奇异值矩阵。
* $C_{A,l}(i,j)$: 子空间A在层l的度量矩阵元素，定义为$\|U_{A,l}[i] - U_{A,l}[j]\|_2^2$。
* $\pi^*$: 最优GWD传输计划矩阵，维度$r \times r$。
* $M_l$: 动态映射矩阵，维度$r \times r$。
* $\psi_{A,l} = [\bar{s}_{A,l}, \bar{h}_{A,l}, \bar{d}_l]$: 层l的子空间编码向量，包含奇异值期望$\bar{s}_{A,l}$、熵$\bar{h}_{A,l}$和GWD距离$\bar{d}_l$。
* $\psi'_{A,l} = [\bar{s}_{A,l}, \bar{h}_{A,l}]$: (新增) 第l层模型A的**内在属性向量**，不包含距离项。
* $\mu_d, \sigma_d$: (新增) 所有层GWD距离 $\bar{d}_l$ 的均值和标准差。
* $z_l$: (新增) 第l层GWD距离的Z-score。
* $g_l$: (新增) 第l层的上下文感知门控因子。
* **$TFI_{l,i}$**: Task Fusion Importance，第l层第i个子空间组件的重要性分数。
* **$TOS_l$**: (更新) Task Overlap Score。
* $\tau_B = W_{B,l} - W_{A,l}$: 任务向量。
* $\tau_{proj}'$: 动态投影后的任务向量分量。
* $\tau_{ortho}$: 正交分量。
* $W_{l}^*$: 第l层的融合权重矩阵。
* 参数：$\beta > 0$ (温度参数，控制距离惩罚的锐度，通常0.1)、$\epsilon > 0$ (小正则化常数，避免除零，通常1e-6)、$\lambda_l \in [0,1]$ (融合权重)。

#### **详细步骤和公式推导**

**1. 子空间提取阶段** (逻辑和公式不变)

* 对每层$l$的权重$W_{A,l}, W_{B,l}$进行SVD分解，保留top-r的奇异值和奇异向量，得到$U_{A,l}, S_{A,l}$和$U_{B,l}, S_{B,l}$。
* 推理：此步骤从权重中提取核心功能子空间，为后续对齐提供基础表示，过程数据独立，计算高效。

**2. 动态Gromov-Wasserstein对齐阶段** (逻辑和公式不变)

* 计算度量矩阵 $C_{A,l}$ 和 $C_{B,l}$。
* 引入基于注意力的动态映射矩阵 $M_l = \text{softmax}( (U_{A,l}W_q)(U_{B,l}W_k)^T / \sqrt{r} )$。
* 将 $M_l$ 应用于B的子空间：$U_{B,l}' = M_l U_{B,l}$，并更新其度量矩阵 $C_{B,l}'$。
* 计算GWD距离：$\bar{d}_l = GWD(C_{A,l}, C_{B,l}')$，并求解最优传输计划 $\pi^*$。
* 推理：此步骤是核心创新，通过动态映射解决了多模态噪声导致的静态对齐不稳问题，输出的$\bar{d}_l$和$\pi^*$为后续步骤提供了关键的对齐信息。

**3. 子空间编码阶段** (逻辑和公式不变)

* 计算奇异值概率 $p_{A,l,i} = \text{softmax}(S_{A,l}[i])$。
* 计算期望 $\bar{s}_{A,l} = \sum_{i=1}^r p_{A,l,i} S_{A,l}[i]$。
* 计算熵 $\bar{h}_{A,l} = -\sum_{i=1}^r p_{A,l,i} \log p_{A,l,i}$。
* 从上一步获得距离 $\bar{d}_l$。
* 构建编码向量 $\psi_{A,l} = [\bar{s}_{A,l}, \bar{h}_{A,l}, \bar{d}_l]$。
* 推理：此步骤将对齐结果量化为结构化的编码向量，捕捉了子空间的强度、多样性和对齐成本，为最终的融合决策提供依据。

**4. TEFM集成阶段** (映射部分更新)

* **全局对齐景观评估 (新增前置步骤)**
    * **计算**: 遍历所有层 $l=1, \dots, L$，收集所有GWD距离 $\{\bar{d}_1, \bar{d}_2, \dots, \bar{d}_L\}$。
    * 计算该分布的均值 $\mu_d$ 和标准差 $\sigma_d$。
    * **推理**: 此步骤为CAGA门控机制提供了必要的全局上下文。

* **定位 (Localization) - (保持不变)**
    * **公式**:
        $$
        TFI_{l,i} = \frac{S_{A,l}[i]}{\bar{h}_{A,l} + \epsilon} \cdot \exp(-\beta \bar{d}_l)
        $$
    * **推理**: 此公式已被验证是有效的，它基于组件的内在强度、所在层的专业化程度和局部对齐成本，为模型组件筛选提供了可靠依据。我们保持此部分不变。

* **映射 (Mapping) - (已修正)**
    * **公式推导**:
        任务重叠分数 $TOS_l$ 用于调整最优传输计划 $\pi^*$，其计算被更新为上下文感知的门控衰减机制。
        1.  定义不含距离项的内在属性向量 $\psi'_{A,l} = [\bar{s}_{A,l}, \bar{h}_{A,l}]$ 和 $\psi'_{B,l} = [\bar{s}_{B,l}, \bar{h}_{B,l}]$。
        2.  计算门控因子 `g_l`：
            $$
            g_l = \exp\left(-\max\left(0, \frac{\bar{d}_l - \mu_d}{\sigma_d + \epsilon}\right)\right)
            $$
        3.  计算最终的 $TOS_l$:
            $$
            TOS_l = \underbrace{\text{cosine}(\psi'_{A,l}, \psi'_{B,l})}_{\text{内在属性相似度}} \cdot \underbrace{g_l \cdot \exp(-\beta \bar{d}_l)}_{\text{上下文感知的对齐质量}}
            $$
    * **逻辑推理**:
        * `TOS_l`现在是一个更智能的度量。`cosine`项判断两个层的功能属性是否相似。对齐质量项 $g_l \cdot \exp(-\beta \bar{d}_l)`$则回答了“这种对齐在多大程度上是可信的？”。
        * 如果一个层的对齐成本 `\bar{d}_l` 正常（`z_l \le 0`），则 `g_l=1`，`TOS_l` 的行为与原方法一致，完全由局部信息决定。
        * 如果一个层的对齐成本 `\bar{d}_l` 是一个统计上的异常高值（`z_l > 0`），则 `g_l` 会急剧下降，`TOS_l` 会被额外压制，从而大大削弱这个不可靠的对齐关系对最终传输计划`\pi^*`的影响。

* **融合 (Fusion)** (逻辑不变，输入更鲁棒)
    
    * **推理**: 融合步骤的公式保持不变。但由于它所依赖的`TOS_l`现在能更智能地处理异常对齐层，调整后的传输计划 `\pi^*` 会更加鲁棒，更倾向于在结构可靠的层之间进行知识传递，从而提高了最终融合模型 $W_l^*$ 的性能稳定性。

#### **理论证明：鲁棒性定理**

**定理**: 采用上下文感知门控衰减（CAGA）机制计算`TOS_l`，能够提高DGSM-TEFM融合框架对层级对齐异质性（layer-wise alignment heterogeneity）的鲁棒性。具体而言，该机制能够有界地限制统计异常的对齐层对最优传输计划$\pi^*$的扰动。

**证明思路**:

1.  **扰动分析**: 设 $\pi^*_l$ 为第 $l$ 层的原始最优传输计划。调整后的计划为 $\tilde{\pi}^*_l = f(\pi^*_l, TOS_l)$，其中调整函数 $f$ 的强度与 $|TOS_l|$ 正相关。我们需要证明，当 $\bar{d}_l$ 是异常值时，$|TOS_l|$ 会被有效抑制。

2.  **TOS的有界性**:
    * `cosine`项有界于 `[-1, 1]`。
    * 局部衰减项 `\exp(-\beta \bar{d}_l)` 有界于 `(0, 1]`。
    * 门控因子 `g_l` 有界于 `(0, 1]`。
    * 因此，`TOS_l` 始终有界于 `[-1, 1]`，保证了数值稳定性。

3.  **异常值衰减证明**:
    * 考虑当第 $k$ 层的对齐成本 $\bar{d}_k$ 是一个统计异常值，即其Z-score $z_k = (\bar{d}_k - \mu_d) / \sigma_d \to \infty$。
    * 根据`g_l`的定义，$g_k = \exp(-z_k)$。当 $z_k \to \infty$ 时，$g_k \to 0$。
    * 因此，即使 `cosine` 项为1，`TOS_k` 也会因为 $g_k$ 而趋近于0:
        $$
        \lim_{z_k \to \infty} TOS_k = \lim_{z_k \to \infty} \text{cosine}(\cdot) \cdot e^{-z_k} \cdot e^{-\beta \bar{d}_k} = 0
        $$
    * 这意味着，当一个层的对齐成本是统计上的极端异常值时，其`TOS`分数被强制归零。这使得对 $\pi^*_k$ 的调整 `f(\pi^*_k, TOS_k)` 趋向于恒等变换，即 $\tilde{\pi}^*_k \approx \pi^*_k$（或任何表示“无信息”调整的基线）。CAGA机制成功地将这个异常层的影响“隔离”，防止其污染映射过程。

4.  **常规值保持**:
    * 对于 $\bar{d}_l \le \mu_d$ 的层，我们有 $z_l \le 0$，因此 $g_l=1$。
    * 此时，$TOS_l = \text{cosine}(\psi'_{A,l}, \psi'_{B,l}) \cdot \exp(-\beta \bar{d}_l)$，完全恢复为原方法的形式。
    * 这证明了CAGA在处理正常对齐层时，不会损失原方法利用局部距离信息的能力。

**结论**: CAGA机制通过一个创新的门控设计，成功地在保留局部敏感性和引入全局鲁棒性之间取得了平衡。它只在必要时介入，对统计上可疑的对齐进行精准的“降权”，而在常规情况下则保持原方法的有效行为。这种“外科手术式”的调整，极大地增强了整个融合框架在面对复杂的、非均匀的对齐质量时的稳定性和最终性能。